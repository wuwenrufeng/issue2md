name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Run tests
        id: test
        run: make test 2>&1 | tee test.log

      - name: Run lint
        id: lint
        run: make lint 2>&1 | tee lint.log

      - name: Run build
        id: build
        run: make build 2>&1 | tee build.log

      # 收集失败日志（仅在前面步骤失败时执行）
      - name: Collect failure logs
        if: failure()
        run: |
          {
            echo "分析以下 CI 失败日志并提供修复建议："
            echo ""

            if [ "${{ steps.test.outcome }}" == "failure" ]; then
              echo "=== 测试失败 ==="
              cat test.log
              echo ""
            fi

            if [ "${{ steps.lint.outcome }}" == "failure" ]; then
              echo "=== Lint 失败 ==="
              cat lint.log
              echo ""
            fi

            if [ "${{ steps.build.outcome }}" == "failure" ]; then
              echo "=== 构建失败 ==="
              cat build.log
              echo ""
            fi

            echo "请："
            echo "  1. 找出失败的根因"
            echo "  2. 给出具体的修复步骤"
            echo "  3. 如果需要更多信息，列出缺少的信息"
          } > failure-summary.txt

      # 失败时才触发 Claude 诊断
      - name: AI Code Analysis (on failure)
        if: failure()
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          prompt: ""
          input_file: failure-summary.txt

          settings: |
            {
              "env": {
                "ANTHROPIC_AUTH_TOKEN": "${{ secrets.ANTHROPIC_AUTH_TOKEN }}",
                "ANTHROPIC_BASE_URL": "${{ vars.ANTHROPIC_BASE_URL }}",
                "API_TIMEOUT_MS": "${{ vars.API_TIMEOUT_MS }}",
                "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": "${{ vars.CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC }}"
              }
            }